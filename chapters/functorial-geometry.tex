\nocite{eisenbud-harris:2000}

\chapter{Functorial geometry}
\minitoc

%\section{Commutative algebra}



\NewDocumentCommand\Inv{sm}{\IfBooleanTF{#1}{\prn{#2}}{#2}^{-1}}
\NewDocumentCommand\Aff{}{\mathbf{Aff}}
\NewDocumentCommand\Sch{}{\mathbf{Sch}}
\NewDocumentCommand\AffFP{}{\mathbf{Aff}_{\textit{f.p.}}}
\NewDocumentCommand\Ring{}{\mathbf{Ring}}
\NewDocumentCommand\LocRing{}{\mathbf{Ring}_{\mathrm{Loc}}}
\NewDocumentCommand\RingFP{}{\mindelim{1}\mathbf{Ring}_{\textit{f.p.}}}
\NewDocumentCommand\RingedTOP{}{\mathbf{RingedTop}}
\NewDocumentCommand\LocRingedTOP{}{\mathbf{RingedTop}_{\mathrm{Loc}}}
\NewDocumentCommand\Spec{g}{\operatorname{Spec}\IfValueT{#1}{#1}}
\NewDocumentCommand\Zar{m}{\mathrm{Zar}\prn{#1}}
\NewDocumentCommand\Str{G{\bullet}}{\mathcal{O}_{#1}}
\NewDocumentCommand\GS{g}{\Gamma\IfValueT{#1}{\prn{#1}}}
\NewDocumentCommand\Ind{m}{\mathrm{Ind}\prn{#1}}
\NewDocumentCommand\Pts{m}{\mathrm{Pt}\prn{#1}}

I claim no originality for these notes! They are drawing together a number of
ideas on the functorial formulation of algebraic geometry, due to a number of
authors.\footnote{See for instance \citet{lurie:dag:5,cole:spectra:reprint,hakim:1972,sga:4,demazure-gabriel:1980,blechschmidt:2017}.} The aim of these notes is to each myself some geometry in a language I
understand --- consequently, the presentation goes in a more topos theoretic
direction than most expositions.

I am testing the hypothesis that if one allows oneself the ``forbidden
knowledge'' of approximately two semesters of topos theory, a number of things
become easier and less technical. These notes owe a lot to \citet{blechschmidt:2017}.


\section{Topos theoretic preliminaries}

We share some notations and conventions with \citet{anel-joyal:2019}.

\begin{para}
  %
  Let $\CCat$ be a category; we will write $\AlxTop{\CCat}$ for the \emph{Alexandrov topos}
  defined by the equation $\Sh{\AlxTop{\CCat}} = \CoPsh{\CCat} =
  \Psh{\OpCat{\CCat}}$. A good intuition is that $\CCat$ is the category of
  finitely presented models for a finite limit theory $\ThCat$, and then
  $\AlxTop{\CCat}$ is the classifying topos or moduli space of $\ThCat$-models.

  The category of points of $\AlxTop{\CCat}$ is $\Ind{\CCat}$; in case $\CCat$
  is the category of finitely presented $\ThCat$-models, then $\Ind{\CCat}$ is
  the category of \emph{all} $\ThCat$-models, being the free completion under
  filtered colimits.
  %
\end{para}

\begin{para}
  %
  Let $\CCat$ be a category; we will write $\PrTop{\CCat}=
  \AlxTop{\OpCat{\CCat}}$ for the topos defined by the equation
  $\Sh{\PrTop{\CCat}} = \Psh{\CCat}$. Here, the intuition is best when $\CCat =
  \ThCat$ is a finite limit theory; then $\PrTop{\ThCat}$ is the classifying
  topos of $\ThCat$-models.
  %
\end{para}

\begin{para}
  %
  The important idea hiding in the intuitions above is the famous
  Gabriel--Ulmer duality between a finite limit theory and its category of its
  finitely presented models~\citep{gabriel-ulmer:1971}, itself a variant of the
  Lawvere duality between a finite product theory and its category of free
  finitely generated models~\citep{lawvere:thesis}.
  %
\end{para}

\subsection{Stalkwise conditions}

\begin{para}
  %
  In classic presentations of scheme theory, many conditions on sheaves of
  algebras are tested stalkwise; this is only possible because most topoi under
  consideration in geometry have enough points!
\end{para}

\begin{para}
  %
  Let $\XTop$ be a topos; we denote by $\Pts{\XTop}$ the category of points
  $\Hom[\TOP]{\Pt}{\XTop}$. Given a point $x:\Pts{\XTop}$ and a sheaf
  $E:\Sh{\XTop}$, the \emph{stalk} $E_x : \SET$ of $E$ at $x$ is the inverse
  image $x^*E$.
  %
\end{para}
 
\begin{para}
  %
  Let $\XTop$ be a topos; $\XTop$ is said to \emph{have enough points} when any
  morphism of $\Mor[f]{E}{F} : \Sh{\XTop}$ is an isomorphism if for every point $x: \Pts{\XTop}$ the function on stalks $\Mor[f_x]{E_x}{F_x}$ is an isomorphism.
  %
\end{para}


\begin{para}
  %
  Rather than stating conditions relative to the stalks, we prefer to state
  them \emph{directly} in terms of the internal logic of each topos. This
  approach is more robust, and works even when a topos doesn't have enough
  points.
  %
\end{para}

\section{Commutative algebra and classifying topoi}

In these notes, all rings are assumed commutative with unit and homomorphisms
of rings are assumed to preserve $1$.

\begin{para}
  %
  A ring is called \emph{local} it has a unique maximal ideal. When $A,B$ are
  local rings, a homomorphism $\Mor[f]{A}{B}$ is local when it reflects
  invertibility, i.e.\ for $a\in A$ if $f(a)$ is a unit then $a$ is a unit.
  %
\end{para}

\begin{para}
  %
  We will write $\Ring$ for the category of rings and ring homomorphisms and
  $\LocRing$ for the category of local rings and local ring homomorphisms.
  %
\end{para}

\subsection{Classifying topoi}

\begin{para}
  %
  The theories of rings and local rings are both geometrical; consequently,
  they both have classifying topoi, respectively $\brk{\Ring},\brk{\LocRing}$.
  These topoi can be constructed manually, but what really matters is their
  universal property!

  We will write $\SET\brk{\Ring} = \Sh{\brk{\Ring}}$ for the corresponding
  category of sheaves, to emphasize the sense in which a classifying topos
  freely adds a generic model of a given theory to the background set theory.
  %
\end{para}

\begin{para}
  %
  The classifying topos of rings is the Alexandrov topos $\brk{\Ring} =
  \AlxTop{\RingFP}$; on the other hand, the classifying topos of local rings
  has a more complex and famous construction known as the \emph{Zariski topos}.
  In particular, $\SET\brk{\LocRing}$ is a localization of $\SET\brk{\Ring}$
  generated by the \emph{Zariski topology}.
  %
\end{para}

% \section{Affine schemes}
% 
% \begin{para}
%   %
%   An \emph{affine scheme} is the formal dual of a commutative ring, i.e.\ an
%   object of the category $\Aff = \OpCat{\Ring}$. 
%  % When $A$ is a commutative
%  % ring, we will write $\Spec{A}$ for the corresponding affine scheme;
%  % conversely, when $X$ is an affine scheme, we write $\Str{X}$ for the
%  % corresponding commutative ring.
%   %
% \end{para}
% 
% \begin{para}
%   A \emph{distinguished open immersion} of affine schemes is the dual to a
%   localization map $\Mor{A}{A\brk{\Inv{f}}}$ of commutative rings for some $f \in A$.
%   %in which $Y \cong \Spec{\Str{X}\brk{f^{-1}}}$ for a function $f \in
%   %\Str{X}$. 
% \end{para}
% 
% %\begin{definition}
% %  A finitely presented affine scheme is an object of the category $\AffFP = \OpCat{\RingFP}$.
% %\end{definition}
% 

\section{Geometric schemes, affine and general}

We present the classic perspective of schemes as locally ringed topoi.

\subsection{Locally ringed topoi}

\begin{para}
  %
  A \emph{ringed topos} is a pair $\prn{\XTop,\Str{\XTop}}$ where $\XTop$ is a
  topos and $\Str{\XTop}$ is a \emph{sheaf of rings} in on $\XTop$, i.e.\
  morphism of topoi $\Mor{\XTop}{\brk{\Ring}}$.
%
  We will frequently abuse notation by writing $\XTop$ for the pair
  $\prn{\XTop,\Str{\XTop}}$.
\end{para}

\begin{para}
  The correct notion of morphism between ringed topoi is given by the \emph{lax
  slice} 2-category $\RingedTOP = \LaxSl{\TOP}{\brk{\Ring}}$ whose objects are
  evidently the ringed topoi.
  %
  Consequently, a 1-morphism of ringed topoi
  $\Mor{\prn{\XTop,\Str{\XTop}}}{\prn{\YTop,\Str{\YTop}}}$ is a morphism of
  topoi $\Mor[f]{\XTop}{\YTop}$ together with a morphism of ring objects
  $\Mor[f^\sharp]{f^*\Str{\YTop}}{\Str{\XTop}}$ called the \emph{comorphism}.
  %
\end{para}

\begin{para}
  From the algebraic perspective, the structure sheaf
  $\Mor[\Str{\XTop}]{\XTop}{\brk{\Ring}}$ is a lex and cocontinuous functor
  $\Mor[\Str{\XTop}^*]{\SET\brk{\Ring}}{\Sh{\XTop}}$. Precomposing with the
  Yoneda embedding, one obtains a functor $\Mor{\OpCat{\RingFP}}{\Sh{\XTop}}$
  that we shall also denote by $\Str{\XTop}^*$.

  Every finitely presented commutative ring can be thought of as a ``context''
  in the language of rings, where there are two distinguished forms of context extension:
  freely adding a new element, and adding an inverse to an existing element.
%
  Letting $A = \mathbb{Z}\brk{x}$ be the free ring generated by a single element, it is
  correct to think of $\Str{\XTop}^*A$ as the sheaf collection of elements of
  $\Str{\XTop}$; likewise, it is correct to think of
  $\Str{\XTop}^*\prn{A\brk{\Inv{x}}}$ as the sheaf of units of $\Str{\XTop}$.
\end{para}

\begin{para}
  %
  A locally ringed topos is a ringed topos $\XTop$ such that $\Str{\XTop}$ is a
  local ring, i.e.\ a ring object such that ``$\Str{\XTop}$ has a unique
  maximal ideal'' holds in the internal logic of $\Sh{\XTop}$.
%
  A morphism of locally ringed topoi is a morphism of ringed topoi
  $\Mor[\prn{f,f^\sharp}]{\XTop}{\YTop}$ such that the induced naturality
  square for each distinguished open immersion is cartesian in $\Sh{\XTop}$,
  fixing a finitely presented commutative ring $A$ and an element $a\in A$:
  \[
    \DiagramSquare{
      nw/style = pullback,
      sw = \prn{f^*\Str{\YTop}}^*{A},
      nw = \prn{f^*\Str{\YTop}}^*\prn{A\brk{\Inv{a}}},
      se = \Str{\XTop}^*{A},
      ne = \Str{\XTop}^*\prn{A\brk{\Inv{a}}},
      width = 3cm
    }
  \]

  The role of these cartesian squares can be understood as follows, in the
  internal language of $\Sh{\XTop}$: they state that an element of the pulled
  back local ring $f^*\Str{\YTop}$ is taken by $f^\sharp$ to a unit of
  $\Str{\XTop}$ if and only if it was already a unit in $f^*\Str{\YTop}$ ---
  which is the same as $f^\sharp$ being a local ring map.
\end{para}

\begin{para}
  %
  An open immersion of locally ringed topoi is one of the form
  $\EmbMor[j]{\YTop}{\XTop}$ such that underlying morphism of topoi is an open
  immersion, and $\Spec{\YTop} \cong j^*\Spec{\XTop}$.
  %
\end{para}




\NewDocumentCommand\PrimeIdl{}{\mathbf{PrimeIdl}}

\subsection{The spectrum of a commutative ring}\label{sec:geometric-spectrum}

\begin{para}\label{para:prime-ideal-localization}
  Given a prime ideal $\frk{a}\subseteq
  A$ of a ring $A$, one may form the localization $\Mor{A}{A_\frk{p}}$ where $A_{\frk{p}} =
  A\brk{\Inv*{A\setminus\frk{p}}}$ (which is a local ring).
\end{para}


\begin{para}\label{para:spec-underlying-space}
  %
  Consider the geometric theory of a ring equipped with a prime ideal; this
  gives rise to a projection of classifying topoi
  $\Mor{\brk{\PrimeIdl}}{\brk{\Ring}}$. The fiber of $\brk{\PrimeIdl}$ over a
  ring $A$ is then the classifying topos of prime ideals of $A$, the underlying space of the \emph{spectrum} of $A$.
\end{para}

\begin{para}\label{para:localization-geom-mor}
  %
  We will exhibit a morphism of topoi $\Mor{\brk{\PrimeIdl}}{\brk{\LocRing}}$
  that takes a ring equipped with a prime ideal $\frk{p}\subseteq{A}$ to the
  local ring $A_\frk{p}$. Such a morphism is nothing more than a local ring
  defined in the internal type theory of the classifying topos of prime ideals!
  The localization at a prime makes sense in any topos, so we simply take the
  generic ring equipped with a prime ideal $\prn{U,\frk{p}}$ of
  $\SET\brk{\PrimeIdl}$ to the local ring $U_{\frk{p}}$.
  %
\end{para}

\begin{para}
  The \emph{spectrum} of a ring is the locally ringed topos defined below using \cref{para:spec-underlying-space,para:localization-geom-mor}.
  \[
    \begin{tikzpicture}[diagram]
      \SpliceDiagramSquare{
        nw/style = pullback,
        nw = \Spec{A},
        ne = \brk{\PrimeIdl},
        se = \brk{\Ring},
        sw = \Pt,
        south = A,
        width = 2.5cm,
      }
      \node (nee) [above = 2.5cm of ne] {$\LocRing$};
      \path[->] (ne) edge (nee);
      \path[->,bend left = 20] (nw) edge node [sloped,above] {$\Str{\Spec{A}}$} (nee);
    \end{tikzpicture}
  \]

  We see that this assignment is contravariantly (pseudo)-functorial, arguing that a
  morphism of rings $\Mor{A}{B}$ sends a prime of $B$ to a prime of
  $A$ under inverse image. 
\end{para}


\begin{para}
  %
  Classically, the spectrum of a ring is a locally ringed topological space
  $\Spec{A}$ and the topos we have constructed here is called the \emph{little
  Zariski topos} of $A$. We prefer to speak of our topos as the spectrum, and
  refer to $\Sh{\Spec{A}} = \SET\brk{\PrimeIdl\prn{A}}$ as the \emph{little Zariski logos} of $A$.
  %
\end{para}



\subsection{The big Zariski topos of a commutative ring}

\begin{para}\label{para:big-zariski}
  Let $A$ be a commutative ring, i.e.\ a morphism of topoi
  $\Mor{*}{\brk{\Ring}}$; then the \emph{geometric spectrum} of $A$ is the
  locally ringed topos defined by the following \emph{comma square} in the
  category of topoi:
  \[
    \begin{tikzpicture}[diagram]
      \SpliceDiagramSquare{
        nw/style = {pullback=<-},
        nw = \Zar{A},
        ne = *,
        se = \brk{\Ring},
        sw = \brk{\LocRing},
        west = \Str{\Zar{A}},
        south/style = embedding,
        east = A,
        south = i,
        width = 2.5cm,
        west/style = exists,
      }
      \draw[two cell] (ne) to[bend right=10] node [midway] {$$} (sw);
    \end{tikzpicture}
  \]
\end{para}

\begin{para}
  %
  From \cref{para:big-zariski}, it can be seen that $\Zar{A}$ is the
  classifying topos of \emph{local $A$-algebras}. Let $\XTop$ be a topos; then
  a morphism $\Mor{\XTop}{A}$ consists of a local ring
  $\Mor[B]{\XTop}{\brk{\LocRing}}$ together with a homomorphism of rings
  $\Mor[\alpha]{A_{\vert \XTop}}{i\circ B}$.
  %
  \[
    \begin{tikzpicture}[diagram]
      \SpliceDiagramSquare{
        nw = \Zar{A},
        ne = *,
        se = \brk{\Ring},
        sw = \brk{\LocRing},
        west = \Str{\Zar{A}},
        west/node/style = {mute,upright desc},
        west/style= mute,
        north/style = mute,
        nw/style = {pullback = {<-,mute},mute},
        south/style = embedding,
        east = A,
        south = i,
        width = 2.5cm,
      }
      \node (nww) [above left = of nw] {$\XTop$};
      \path[->,bend right = 30] (nww) edge coordinate [xshift = 1mm, yshift = 1mm] (l-ctr) node [left] {$B$} (sw);
      \path[->,bend left = 30] (nww) edge coordinate [xshift = -1mm, yshift = -1mm] (r-ctr) (ne);
      \path[->,mute] (nww) edge (nw);
      \draw[two cell] (r-ctr) to[bend right=20] node [midway,sloped,below] {$\alpha$} (l-ctr);
    \end{tikzpicture}
  \]
\end{para}

\begin{para}
  \danger
  %
  The big Zariski topos \emph{is not} obtained as a (weak) pullback of topoi:
  this would make $\Zar{A}$ a subtopos of the point, either the punctual topos
  or the empty topos, depending on whether $A$ is a local ring --- since the
  pullback would be the topoi classifying local rings that are isomorphic to
  $A$!
  %
\end{para}



\begin{para}
  %
  Let $\Mor{A}{B}$ be a morphism of rings; we will show that this gives rise to
  a morphism of topoi $\Mor{\Zar{B}}{\Zar{A}}$ using the universal property
  of the comma square. First, consider the pasting of the morphism $\Mor{A}{B}$
  with the 2-cell of the defining comma square for $\Zar{B}$:
  \[
    \begin{tikzpicture}[diagram]
      \node [pullback = <-] (nw) {$\Zar{B}$};
      \node (ne) [right = 3cm of nw] {$\Pt$};
      \node (sw) [below = of nw] {$\brk{\LocRing}$};
      \node (se) [below = of ne] {$\brk{\Ring}$};
      \path[->] (nw) edge coordinate [xshift=4mm] (StrB) node [left] {$\Str{\Zar{B}}$} (sw);
      \path[embedding] (sw) edge node [below] {$i$} (se);
      \path[->] (nw) edge (ne);
      \path[->,bend right = 30] (ne) edge coordinate [xshift = 1mm] (B) node [left] {$B$} (se);
      \path[->,bend left = 30] (ne) edge coordinate [xshift = -1mm] (A) node [right] {$A$} (se);
      \draw[two cell] (A) to[bend right = 30] (B);
      \draw[two cell] (ne) to[bend right=10] (sw);
    \end{tikzpicture}
  \]

  From the composite 2-cell, we have desired morphism of topoi:
  \[
    \begin{tikzpicture}[diagram]
      \SpliceDiagramSquare{
        nw = \Zar{A},
        ne = *,
        se = \brk{\Ring},
        sw = \brk{\LocRing},
        west = \Str{\Zar{A}},
        west/node/style = {upright desc},
        nw/style = {pullback = <-},
        south/style = embedding,
        east = A,
        south = i,
        width = 2.5cm,
      }
      \node (nww) [above left = of nw] {$\Zar{B}$};
      \path[->,bend right = 30] (nww) edge coordinate [xshift = 1mm, yshift = 1mm] (l-ctr) node [left] {$\Str{\Zar{B}}$} (sw);
      \path[->,bend left = 30] (nww) edge coordinate [xshift = -1mm, yshift = -1mm] (r-ctr) (ne);
      \path[->] (nww) edge (nw);
      \draw[two cell] (r-ctr) to[bend right=20] node [midway,sloped,above,] {$\simeq$} (nw);
      \draw[two cell] (nw) to[bend right=20] node [midway,sloped,above,] {$\simeq$} (l-ctr);
      \draw[two cell] (ne) to[bend right=10] (sw);
    \end{tikzpicture}
  \]
  %
\end{para}

\subsection{Affine geometric schemes}

\begin{para}
  %
  An \emph{affine geometric scheme} is a locally ringed space lying in the
  essential image of the pseudofunctor
  $\Mor[\Spec]{\OpCat{\Ring}}{\LocRingedTOP}$ defined in
  \cref{sec:geometric-spectrum}; explicitly, this an affine geometric scheme is
  a locally ringed topos that is \emph{equivalent} to one of the form
  $\Spec{A}$.  Will write $\Aff$ for the full subcategory of $\LocRingedTOP$
  spanned by affine geometric schemes.

  However, note that $\Spec{A}$ is localic; an equivalence of localic topoi
  corresponds to an \emph{isomorphism} between locales because a preorder has
  no non-trivial isomorphisms.
  %
\end{para}

\begin{para}
  %
  We observe, but do not prove, that the restriction of $\Spec$ to affine
  schemes exhibits an equivalence $\OpCat{\Ring}\simeq\Aff$.
  %
\end{para}

%\begin{para}
%  %
%  A \emph{distinguished open immersion} of affine schemes is a morphism of the
%  form $\Mor[D\prn{a}]{\Spec{A\brk{\Inv{a}}}}{\Spec{A}}$ for some element $a \in A$.
%  %
%\end{para}

\NewDocumentCommand\Sub{m}{\mathbf{Sub}\prn{#1}}

\begin{para}
  %
  Let $\XTop$ be a locally ringed topos. $\XTop$ is a called a \emph{scheme}
  when there exists a set of open immersions $\EmbMor{\XTop_{U_i}}{\XTop}$ such
  that $\bigvee U_i=\top$ and each $\XTop_{U_i}$ is affine. We define $\Sch$ to
  be the full subcategory of $\LocRingedTOP$ spanned by schemes.
  %
\end{para}



\clearpage

\section{[My plan]}

\begin{enumerate}
  \item Define geometric schemes as locally ringed topoi covered by (geometric) affine schemes

  \item Define big zariski topos, nerve / functor of points of a geometric scheme

  \item Define open immersions into the functor of points, eliminating enough cuts to kill all references to geometric schemes

  \item Define functorial schemes 
\end{enumerate}
